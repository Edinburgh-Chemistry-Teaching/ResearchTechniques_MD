<!DOCTYPE html>
<html lang="en-UK">

<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, user-scalable=yes" name="viewport"/>
    <meta content="Session 3: Layered material simulations" name="description"/>
    <!--    <link href="https://fonts.googleapis.com" rel="preconnect">-->
    <!--    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">-->
    <!--    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:ital,wght@0,400;0,600;1,400&display=swap"-->
    <!--          rel="stylesheet">-->
    <link data-toggle="true" href="../scripts/style.css" rel="stylesheet"/>
    <title>Session 3</title>
</head>


<body>

<div class="box">
    <h1 id="title">Layered Material Setup</h1>
</div>
<div class="box">
    <h2 id="outcomes">Learning Outcomes</h2>
    <p>By the end of this session you should be able to:</p>
    <ul>
        <li>Prepare a simple input file for a simulation</li>
        <li>Run a simple simulation of a layered material</li>
        <li>Visualise the results of the simulation</li>
    </ul>
</div>
<div class="box">
    <h2 id="overview">Contents</h2>
</div>
<div class="box">
    <h2 class="enum" id="toc_1">Introduction</h2>
    <p>
        <em>This tutorial was created by Hannah Pollak and Valentina Erastova and is based upon the <a
                href="https://www.erastova.xyz/teaching/practical-simulations-for-molecules-and-materials/material-simulations/material-simulations-set-up/">Layered
            material simulations set up</a> tutorial by Valentina Erastova.</em>
    </p>
    <p>
        Clays are a diverse group of minerals that are found in soils and sediments throughout the world.
        Their basic structural unit is a layer composed of one or two sheets of silica tetrahedra,
        [Si<sup>4+</sup>O<sub>5</sub>]
        and one sheet of divalent or trivalent metal octahedra, [M<sup>2+</sup><sub>3</sub>(OH)<sub>2</sub>O<sub>4</sub>]
        (M<sup>2+</sup>
        = Mg<sup>2+</sup>, Fe<sup>2+</sup>, ...),
        or [M<sup>3+</sup><sub>2</sub>(OH)<sub>2</sub>O<sub>4</sub>] (M<sup>3+</sup> = Al<sup>3+</sup>, Fe<sup>3+</sup>).
        These layers are stacked on top of each other to form a 3D structure.
        So&dash;called <em>isomorphous substitution</em> of tetrahedral Si<sup>4+</sup> by a M<sup>3+</sup> ion or
        octahedral
        M<sup>3+</sup>/M<sup>2+</sup> by M<sup>2+</sup>/M<sup>1+</sup> ions
        result in a net negative charge on the clay mineral. This negative <em>layer charge</em> is balanced by the
        presence
        of cations (Na<sup>+</sup>, K<sup>+</sup>, Ca<sup>2+</sup>, Mg<sup>2+</sup>, ...) in the interlayer space.
    </p>
    <div class="flex-figure">
        <figure>
            <img alt="" class="fit-picture" decoding="auto"
                 src="img/clay_sheet_structure.png" width="40%"/>
            <img alt="" class="fit-picture" decoding="auto" src="img/clay_with_IL.png"
                 width="50%"/>
            <figcaption>
                Side view illustrations of clay sheet structure and composition (left) and two stacked clay with
                interlayer space (right).
            </figcaption>
        </figure>
    </div>
</div>
<!--<div class="box" style="width: 50%; border: solid 1px dimgray; background-color: #b3d4fc; color: dimgray">-->
<!--    <p>-->
<!--        Their unique structure dictates their physical and chemical behaviour, as well as their interactions with other-->
<!--        molecules and ions.-->
<!--        Clays for all the 3 different parts.</p>-->
<!--    <ul>-->
<!--        <li>Medicinal and Biological chemistry<br>-->
<!--            Clay minerals have a wide range of applications in the pharmaceutical industry. They are employed as-->
<!--            excipients and drug delivery agents, as well as, thickeners and absorbents.-->
<!--        </li>-->
<!--        <li>Materials chemistry<br>-->
<!--            Clay minerals are used in the production of ceramics, glass, paper, paints, rubber, polymers,-->
<!--            insecticides and many other industrial and domestic products.-->
<!--        </li>-->
<!--        <li>Analytical chemistry<br>-->
<!--            Clay minerals are used in the analysis of a wide range of materials, including soils, sediments, rocks,-->
<!--            water and air.-->
<!--        </li>-->
<!--    </ul>-->
<!--</div>-->
<div class="box">
    <p>
        Today's system will be a montmorillonite <abbr>MMT</abbr> in contact with water, ions and organic molecules.
        We will start by building the clay sheets from unit cell (<abbr>UC</abbr>) building blocks.
        The composition of this unit cell is the following:
        [Si<sup>4+</sup><sub>8</sub>O<sub>5</sub>][Al<sup>3+</sup><sub>3</sub>Mg<sup>2+</sup>(OH)<sub>2</sub>O<sub>4</sub>]<sup>
        &dash;1</sup>. The &dash;1 charge originates from one of the octahedral Al<sup>3+</sup> atoms being substituted
        by a
        Mg<sup>2+</sup> atom.
        In the session tutorial, the atoms are colour&dash;coded according to the following scheme:</p>

    <table>
        <caption>Atom type colours</caption>
        <colgroup>
            <col span="5">
        </colgroup>
        <thead>
        <tr>
            <th>Element</th>
            <th>Colour</th>
            <th style="color: transparent">empty</th>
            <th>Element</th>
            <th>Colour</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>Si</td>
            <td style="background-color: yellow; font-weight: bolder">yellow</td>
            <td style="color: transparent">empty</td>
            <td>Al</td>
            <td style="background-color: darkcyan; color: white; font-weight: bolder">cyan</td>
        </tr>
        <tr>
            <td>O</td>
            <td style="background-color: red; color: white; font-weight: bolder">red</td>
            <td style="color: transparent">empty</td>
            <td>Mg</td>
            <td style="background-color: darkviolet; color: white; font-weight: bolder">purple</tD>
        </tr>
        <tr>
            <td>H</td>
            <td style="background-color: white; color: black; font-weight: bolder">white</td>
            <td style="color: transparent">empty</td>
            <td>C</td>
            <td style="background-color: #333333; color: white; font-weight: bolder">gray</tD>
        </tr>
        </tbody>
    </table>
    <!--        <span style="align-content: center; text-align: justify; align-items: center">-->
    <div class="flex-figure">
            <figure>
                <img alt="" class="fit-picture" decoding="auto" src="img/uc_top.png"
                     width="35%"/>
                <img alt="" class="fit-picture" decoding="auto" src="img/uc_side.png"
                     width="55%"/>
                <figcaption>
                    Montmorillonite unit cell top view (left) and side view (right).
                </figcaption>
            </figure>
    </div>

    <!--        <figure>-->
    <!--            <img width="250px" decoding="auto" src="img/uc_top.png" class="fit-picture" alt="" />-->
    <!--            <img width="350px" decoding="auto" src="img/uc_side.png" class="fit-picture" alt="" />-->
    <!--        <figcaption>-->
    <!--            Montmorillonite unit cell top view (left) and side view (right).-->
    <!--        </figcaption>-->
    <!--        </figure>-->


    <!--        </span>-->
</div>
<div class="box">
    <h2 class="enum" id="toc_2">Building the clay sheets</h2>
    <p>
        Before you start on this practical, let's create a working directory for this session.
    </p>
    <div class="bbox">
        <h3 id="Creating_the_working_directory"></h3>
        <ul>
            <li>Create the working directory for this session</li>
            <li>Move to your home directory:
                <pre>$ cd </pre>
            </li>
            <li>Copy the <code>session3</code> folder from practicals to your home directory:
                <p>Open a terminal and type:</p>
                <pre>$ cp &dash;r /home/student/practicals/session3 .</pre>
            </li>
            <li>Change into the <code>session3</code> directory:
                <pre>$ cd session3</pre>
            </li>
        </ul>
    </div>
    <!--    <p>-->
    <!--        There are two steps in building a system for an <abbr title="Molecular Dynamics">MD</abbr> simulation:</p>-->
    <!--    <ol>-->
    <!--        <li> Creating the structure</li>-->
    <!--        <li> Assigning the topology</li>-->
    <!--    </ol>-->
    <p>
        The clay model will consist of a single montmorillonite clay sheet. The first step is to create a sheet by
        multiplying a single <abbr>MMT</abbr> <abbr>UC</abbr>.
        This can be done using GROMACS <code>genconf</code>.
    </p>

    <div class="bbox">
        <h3 id="Create_a_clay_sheet"></h3>
        <ul>
            <li>Use <code>genconf</code> to create a single clay sheet from <abbr>MMT</abbr> <abbr>UCs</abbr>
                (<code>MMT.gro</code>) with a cutoff of 1.2 nm:
            </li>
            <li>Usage of <code>genconf</code>: <br>
                <blockquote>
                    <pre>gmx genconf &dash;f STRUCTURES/MMT.gro &dash;nbox &lt;x_ucs&gt; &lt;y_ucs&gt; &lt;z_ucs&gt; &dash;o MMT_slab.gro</pre>
                    <code>&dash;f</code> specifies the structure file of the system to insert into.<br>
                    <code>&dash;nbox</code> defines the number of unit cells to put in each of the <em>x y z</em>
                    directions.<br>
                    <code>&dash;o</code> specifies the output file name.<br>
                    If you only want one layer of clay, use 1 in the z&dash;direction.
                </blockquote>
            </li>
            <li>How many (<abbr>UCs</abbr>) do you need to multiply in x&dash; and y&dash;direction?
                <blockquote>
                    Check the size of unit cell and remember the size of the box has to be at least 2.5 x the size
                    of your cutoff.
                    So, for a cutoff at 1.2&nbsp;nm you have to aim at ~3&nbsp;nm on each side.<br>
                    <i>Remember:</i> The final line in the <code>.gro</code> file shows the x, y and z cell lengths in
                    nanometers.
                </blockquote>
                <div class="flex-figure">
                        <figure>
                            <img alt="" class="fit-picture" decoding="auto"
                                 src="img/sheet_top.png"
                                 width="45%"/>
                            <img alt="" class="fit-picture" decoding="auto"
                                 src="img/sheet_side.png"
                                 width="50%"/>
                            <figcaption>
                                Montmorillonite sheet model top view (left) and side&dash;view (right).
                            </figcaption>
                        </figure>
                    </div>
            </li>
        </ul>
    </div>
    <p>
        The box of this sheet model currently has no space for inserting organic molecules, solvent or ions.
        Therefore, before moving on, you need to change the box height.
    </p>
    <div class="bbox">
        <h3 id="Increase_the_box_height"></h3>
        <ul>
            <li>Edit the gro file to increase the box height</li>
            <li>Increase the box <em>z</em> length by editing the <code>MMT_slab.gro</code> file.
                <blockquote>
                    Where in the <code>.gro</code> file is the box size specified? Adjust the sheet spacing to 50&nbsp;&#8491;
                    using <code>nano</code>
                </blockquote>
                <div class="flex-figure">
                    <figure>
                        <img alt="" class="fit-picture" decoding="auto"
                             src="img/sheet_side_ext_50A.png"
                             width="55%"/>
                        <figcaption>
                            Montmorillonite sheet model side view with extended box height.
                        </figcaption>
                    </figure>
                </div>
            </li>
        </ul>
    </div>
    <h2 class="enum" id="toc_3">Adding decanoic acid molecules</h2>
    Now that you have a clay sheet, you can use <code>insert&dash;molecules</code> to insert decanoic acid molecules
    into
    the vacuum space.
    <div class="bbox">
        <h3 id="Insert_decanoic_acid_molecules"></h3>
        <ul>
            <li>Use <code>insert&dash;molecules</code> to insert 10 decanoic acid molecules into the vacuum space above
                the clay sheet (<code>MMT_slab.gro</code>):
            </li>
            <li>Usage of <code>insert&dash;molecules</code>: <br>
                <blockquote>
                    <pre>gmx insert&dash;molecules &dash;f MMT_slab.gro &dash;ci STRUCTURES/decanoic_acid.gro &dash;nmol &lt;number&gt; &dash;o MMT_dec.gro</pre>
                    <code>&dash;f</code> specifies the coordinate file of the system to insert into.<br>
                    <code>&dash;ci</code> specifies the coordinate file of the molecule to insert.<br>
                    <code>&dash;nmol</code> defines the number of molecules to insert.<br>
                    <code>&dash;o</code> specifies the output coordinate file name.<br>
                    <p>GROMACS will try to fit the requested number of molecules in the available space. It will
                        notify you about whether it was successful or not. <i>If unsuccessful, repeat this step until
                            the requested total number have
                            been added (you may need to lower <code>-nmol
                                &lt;number&gt;
                            </code> if it successfully added some but not all).</i>
                    </p>
                </blockquote>
                <div class="flex-figure">
                    <figure>
                        <img alt="" class="fit-picture" decoding="auto"
                             src="img/sheet_side_dec_50A.png"
                             width="55%"/>
                        <figcaption>
                            Grey decanoic acid molecules inserted into the vacuum space above the clay sheet.
                        </figcaption>
                    </figure>
                </div>
            </li>
        </ul>
    </div>
    <h2 class="enum" id="toc_4">Preparing the topology file</h2>
    <p>
        Before proceeding to the next step in which you will solvate the box, you need to generate a topology
        (<code>.top</code>) file
        that includes all molecules present in the system. The following explains the structure of GROMACS
        topology files in some more detail.
    </p>
    <p>
        In the first section, the force field parameters are defined. These always include combination rules and
        non&dash;bonded interaction parameters (atom types, atomic masses, atomic charges, Lennard&dash;Jones
        parameters).
        They can optionally include
        bonded interaction definitions (bond, angle and dihedral types with bond, angle and dihedral interaction
        force constants and equilibrium values in this order). A detailed explanation can be found in the GROMACS
        documentation pages: <a
            href="https://manual.gromacs.org/current/reference-manual/topologies/topology-file-formats.html#topfile"
            rel="noopener"
            target="_blank">topology files</a>,
        <a href="https://manual.gromacs.org/current/reference-manual/topologies/topologies.html" rel="noopener"
           target="_blank">topologies</a> and
        <a
                href="https://manual.gromacs.org/current/reference-manual/functions/functions.html#ff"
                rel="noopener"
                target="_blank">force fields</a>.<br>
    </p>
    <p>
        Even if they consist of only one atom, all atoms of the system are part of molecules. These are defined
        in the second section, <code>[ moleculetype ]</code>. All molecule type definitions, such as the
        <abbr>MMT</abbr> <abbr>UC</abbr>,
        decanoic acid, water and ions need to be included in the topology file.
    </p>
    <p> Elements from the first two sections are usually defined in separate files that are included in the topology
        file.
        The syntax for including files is <code>#include &quot;&lt;filename&gt;&quot;</code>.</p>
    <p>
        The third section contains the system name and the number of molecules of each type in the system. The
        system section starts with the keyword <code>[ system ]</code> and is followed by a name chosen for the
        system (the choice of the name does not really matter).<br>
        The number of molecules of each type is specified in the <code>[ molecules ]</code> section.</p>
    <p>
        <em>Important:</em> The order of the molecules in the <code>[ molecules ]</code> section must match the
        order of the molecules in the <code>.gro</code> file.

    </p>
    <div class="bbox">
        <h3 id="Generate_the_topology_file"></h3>
        <ol>
            <li>Generate a topology file for the system (<code>MMT_slab.top</code>):</li>
            <li>Open the topology file <code>MMT_slab.top</code> in a text editor to fill in missing
                sections.<br>
                <blockquote>
                    All force field folders (<code>&lt;ForceFieldName.ff&gt;</code>) are located within the
                    <code>FF</code> directory. The force field for clay and water is ClayFF, for organics and ions
                    it is CHARMM36, and for ions it is Ions.
                    Inside each of the folders, you can find the <code>.itp</code> files that contain the various
                    force field parameters. <br>
                    <p class="remember"> Everything that comes after a <code>;</code> will be treated as a comment and
                        is not read by GROMACS.</p>
                </blockquote>
            </li>
            <!--                <li>Include the definition files for combination rules (<code>'forcefield.itp</code>) from ClayFF.-->
            <!--                    <blockquote>-->
            <!--                        <pre>#include "FF/charmm36.ff/forcefield.itp"</pre>-->
            <!--                        All force field folders (<code>&lt;ForceFieldName.ff&gt;</code>) are located within the-->
            <!--                        <code>FF</code> directory. The force field for clay and water is ClayFF, for organics and ions-->
            <!--                        it is CHARMM36 and for ions it is Ions.-->
            <!--                        Inside each of the folders, you can find the <code>.itp</code> files that contain the various-->
            <!--                        force field parameters.-->
            <!--                        The combination rules are only be specified once and will be the same for all atoms even if-->
            <!--                        their parameters belong to different force fields.-->
            <!--                    </blockquote>-->
            <li>Add nonbonded parameter files (<code>ffnonbonded.itp</code>) for clay, organics and ions.
                <blockquote>
                    Clay and water share the same atom types. Therefore, no separate
                    <code>ffnonbonded.itp</code> file needs to be added for water.<br>
                </blockquote>
            </li>
            <li>Add bonded parameters for organics (<code>ffbonded.itp</code>).</li>
            <li>Include molecule definitions for ions (<code>ions.itp</code>), water (<code>spc.itp</code>),
                <abbr>MMT</abbr>
                (<code>MMT.itp</code>) and decanoic acid (<code>decanoic_acid.itp</code>).
                <blockquote>
                    <p class="note">The files containing the decanoic acid and MMT structure parameters are located in
                        the
                        <code>STRUCTURES</code> directory.</p>
                </blockquote>
            </li>
            <li>Complete the molecules section.
                <blockquote>Add entries for all molecules in your <code>.gro</code> file.<br>
                    E.g. for two <abbr>MMT</abbr> <abbr>UCs</abbr> and one decanoic acid, the entry would be:
                    <pre>
[ molecules ]
; Compound  # mols
MMT           2
DECA           1
                </pre>
                </blockquote>

            </li>
        </ol>
    </div>
    <h2 class="enum" id="toc_5">Solvating the system</h2>
    <p>
        Now that you have a topology file, you can use GROMACS to <code>solvate</code> the box.
    </p>
    <div class="bbox">
        <h3 id="Solvate_the_box"></h3>
        <ol>
            <li>Use <code>solvate</code> to solvate the box with water (<code>MMT_dec.gro</code>):</li>
            <li>Make a copy of the topology <code>MMT_slab.top</code> file:
                <blockquote>
                    <pre>$ cp MMT_slab.top MMT_dec_solv.top</pre>
                </blockquote>
            </li>
            <li>Use of <code>solvate</code>: <br>
                <blockquote>
                    <pre>gmx solvate &dash;cp MMT_dec.gro &dash;cs spc216.gro &dash;o MMT_dec_solv.gro &dash;p MMT_dec_solv.top</pre>
                    <code>&dash;cp</code> specifies the input coordinate file of the system to solvate.<br>
                    <code>&dash;cs</code> specifies the water model coordinate file.<br>
                    <code>&dash;o</code> specifies the output coordinate file.<br>
                    <code>&dash;p</code> specifies the input/output topology file.<br>
                    <p>GROMACS will try to fill the available space with solvent and update the number of water
                        (<code>SOL</code>)
                        molecules in the output topology file.
                    </p>
                </blockquote>
                <div class="flex-figure">
                    <div>
                        <figure>
                            <img alt="" class='fit-picture' decoding="auto" src="img/sheet_side_dec_solv_50A.png" width="55%"/>
                            <figcaption>Solvated MMT sheet model with grey decanoic acid molecules in simulation
                                box.
                            </figcaption>
                        </figure>
                    </div>
                </div>
                <p>After this step, make sure to visualise the system in VMD to check that no water molecules
                    were inserted into or very close to the clay sheets. If this was the case, you can either
                    repeat the solvation step (make sure to delete the <code>SOL</code> line from the topology
                    first) or remove the water molecules manually.<br>
                    In order to manually remove water molecules, look at the system in VMD and press &quot;1&quot; on
                    your keyboard to select the water molecules
                    that are too close to the clay. The label of the selected water molecule will then show you
                    which residue you will need to remove from the <code>.gro</code> file. E.g. if the label
                    shows <code>SOL60:HW1</code> (see figure below), you will need to remove the three
                    <code>SOL60</code> lines
                    from the <code>MMT_dec_solv.gro</code> file and change the number of atoms in the header
                    to match the new number of atoms in the file. Make sure to also update the number of water
                    molecules in the <code>MMT_dec_solv.top</code> file.</p>
                <div class="flex-figure">
                    <figure>
                        <img alt="" class="fit-picture"
                             decoding="auto"
                             src="img/sheet_side_water_mol.png"
                             width="55%"/>
                        <figcaption>
                            Water molecule <code>SOL60</code> inside the clay sheet.
                        </figcaption>
                    </figure>
                </div>
            </li>
        </ol>
    </div>
    <h2 class="enum" id="toc_6">Adding ions to neutralise the system</h2>
    <p>
        Now you have a solvated system, but the system has a net negative charge because of the substitutions in the
        clay sheet and the
        deprotonated decanoic acid molecules.
        It is not possible to run a simulation with a charged system. Therefore, you need to neutralise the system
        with cations.
        You can use <code>genion</code> to add ions and neutralise the system.
    </p>
    <div class="bbox">
        <h3 id="Neutralise_the_excess_charge"></h3>
        <ol>
            <li>Neutralise the system with Na<sup>+</sup> ions:</li>
            <li>Generate a run <abbr>TPR</abbr> file for the system (<code>MMT_dec_solv.tpr</code>):
                <p>
                    Since <code>genion</code> is a type of <abbr>MD</abbr> run, you need to first use
                    <code>grompp</code> to
                    generate a <code>TPR</code> file. The contents of the <code>MDP</code> input file is not important
                    for
                    this step, but it has to be given.</p>
                <p>Usage of <code>grompp</code>:</p>
                <blockquote>
                    <pre>gmx grompp &dash;f MDP/genion.mdp &dash;c MMT_dec_solv.gro &dash;p MMT_dec_solv.top &dash;o MMT_dec_solv.tpr &dash;pp MMT_dec_solv_ions.top &dash;maxwarn 1</pre>
                    <code>&dash;f</code> specifies the input run parameter file.<br>
                    <code>&dash;c</code> specifies the coordinate file of the system to solvate.<br>
                    <code>&dash;p</code> specifies the topology file.<br>
                    <code>&dash;o</code> specifies the compiled output <code>.tpr</code> file.<br>
                    <code>&dash;pp</code> specifies the output topology file.<br>
                    <code>&dash;maxwarn</code> specifies the maximum number of warnings that can be ignored.
                    If the protein has a charge, <code>grompp</code> will generate a warning that needs to be
                    ignored.<br>
                    <p class="note"> Because <code>genion</code> is an <abbr>MD</abbr> run, the <code>&dash;pp</code>
                        option
                        to generate a new topology file with ions is used here rather than with the <code>genion</code>
                        command.</p>
                </blockquote>
                <p>
                    <code>grompp</code> will generate a note similar to this one:
                </p>
                <pre>
NOTE 3 [file MMT_slab_dec_solv.top, line 40]:
In moleculetype 'MMT' 32 atoms are not bound by a potential or constraint
to any other atom in the same moleculetype. Although technically this
might not cause issues in a simulation, this often means that the user
forgot to add a bond/potential/constraint or put multiple molecules in
the same moleculetype definition by mistake. Run with <code>&dash;v</code> to get
information for each atom.
</pre>
                <p>
                    This note is not an error, but a warning that the atoms in the clay sheet are not bonded to each
                    other. Because ClayFF is a non&dash;bonded force field, this is not an error, and you can ignore
                    this
                    message.
                </p>
            </li>
            <li>Use <code>genion</code> to neutralise the system with Na<sup>+</sup> ions:
                <p>Usage of <code>genion</code>: </p>
                <blockquote>
                    <pre>gmx genion &dash;s MMT_dec_solv.tpr &dash;o MMT_dec_solv_ions.gro &dash;p MMT_dec_solv_ions.top &dash;pname Na &dash;nname Cl &dash;neutral</pre>
                    <code>&dash;s</code> specifies the input coordinate file of the system to solvate.<br>
                    <code>&dash;o</code> specifies the output coordinate file<br>
                    <code>&dash;p</code> specifies the input topology file<br>
                    <code>&dash;pname</code> specifies the name of the positive ion<br>
                    <code>&dash;nname</code> specifies the name of the negative ion<br>
                    <code>&dash;neutral</code> &ndash; neutralise the system<br>
                    <p>
                        You will be asked which molecules should be replaced with ions. Select the code for the
                        water <code>SOL</code> molecules.
                    </p>
                    <p>GROMACS will try to fill the available space with solvent and update the number of water
                        (<code>SOL</code>)
                        molecules in the output topology file.</p>
                </blockquote>
            </li>
        </ol>
        <div class="flex-figure">
            <figure>
                <img alt=""
                     decoding="auto" src="img/sheet_side_dec_solv_ions_50A.png"
                     width="55%"/>
                <figcaption>
                    Solvated and MMT sheet model in simulation box with grey decanoic acid molecules and pink
                    Na<sup>+</sup> ions.
                </figcaption>
            </figure>
        </div>
    </div>
    <h2 class="enum" id="toc_7">Preparing the <abbr>MD</abbr> simulation parameter files</h2>
    <p>
        Now your system is ready for simulation.
    </p>
    <p>
        You can follow the same procedure as in the previous session to run the simulation.
    </p>
    <div class="bbox">
        <h3 id="Prepare_mdp_files"></h3>
        <ol>
            <li>Use the <code>MDP</code> template files inside the <code>MDP</code> directory and complete
                the
                missing keyword sections:
            </li>
            <li>Energy minimisation: <code>em.mdp</code>
                <br>Set the maximum number of steps to 5000 and the force tolerance to 500&nbsp;
                kJ&nbsp;mol<sup>&dash;1</sup>&nbsp;nm<sup>&dash;1</sup>.
            </li>
            <li>Equilibration: <code>eq.mdp</code><br>
                Set the run time to 100&nbsp;ps and the time step to 1&nbsp;fs.
            </li>
            <li>Production: <code>prod.mdp</code><br>
                Set the run time to 5&nbsp;ns and the time step to 2&nbsp;fs.
            </li>
        </ol>
        <p class="note"> Make sure you provide the parameters for the <code>.mdp</code> file in the correct
            units.
            The units used by <abbr>GROMACS</abbr> can be found in the Reference Manual: <a
                    href="https://manual.gromacs.org/documentation/2019/reference-manual/definitions.html"
                    rel="noopener" target="_blank">manual.gromacs.org/documentation/2019/reference&dash;manual/definitions.html</a>.
        </p>
    </div>
</div>
<div class="box">
    <h2 class="enum" id="toc_8">Minimising the energy</h2>
    <p>
        Let's start with the energy minimisation. This step should not take too long and can be carried out on the
        virtual machine. </p>
    <div class="bbox">
        <h3 id="Run_energy_minimisation"></h3>
        <ol>
            <li>Run the energy minimisation:</li>
            <li>Compile the run topology file for the energy minimisation
                (<code>em.tpr</code>):
                <blockquote>
                    <pre>gmx grompp &dash;f MDP/em.mdp &dash;c MMT_dec_solv_ions.gro &dash;p MMT_dec_solv_ions.top &dash;o em.tpr &dash;pp em.top</pre>
                    <code>&dash;f</code> specifies the input run parameter <code>.mdp</code> file.<br>
                    <code>&dash;c</code> specifies the input coordinate file.<br>
                    <code>&dash;p</code> specifies the topology file.<br>
                    <code>&dash;o</code> specifies the compiled output <code>.tpr</code> file.<br>
                    <code>&dash;pp</code> specifies the output topology file.<br>
                </blockquote>
            </li>
            <li>
                Run the energy minimisation
                <blockquote>
                    <pre>gmx mdrun &dash;s em.tpr &dash;deffnm em &dash;v</pre>
                    <code>&dash;s</code> specifies the compiled input <code>.tpr</code> file.<br>
                    <code>&dash;deffnm</code> specifies the output file naming pattern.<br>
                    <code>&dash;v</code> specifies that the output should be verbose.
                </blockquote>
                <p>
                <p>Before moving on to the equilibration, you should check the energy minimisation log file
                    (<code>MMT_dec_solv_ion_em.log</code>) to make sure that the energy minimisation was successful.
                    If the energy minimisation was successful, the log file should end with a message similar to this
                    one:</p>
                <pre>
Steepest Descents converged to Fmax &lt; 500 in 1209 steps
Potential Energy  = -4.5789000e+06
Maximum force     =  4.9707333e+02 on atom 2904
Norm of force     =  2.2770223e+01
</pre>
                <p class="note">
                    If instead you find something along these lines:
                </p>
                <pre>
Steepest Descents converged to machine precision in 192 steps,
but did not reach the requested Fmax &lt; 500.
Potential Energy  = -6.8659256e+05
Maximum force     =  6.5820524e+07 on atom 715
Norm of force     =  1.6491472e+06
</pre>
                <p>This means that the energy minimisation did not converge, meaning that GROMACS was not able to
                    reach a minimum where the maximum force was below the specified threshold. In this case, you will
                    probably need to
                    repeat parts of the assembly procedure or remove water molecules that are too close to the clay,
                    organics or other waters. Before repeating, follow the <em>EM Troubleshoot</em> instructions.
                </p>
                <div id="EM_toubleshoot"
                     style="padding: 20px;background: #DBE1F1; border: darkslategray; border-width: 1px;border-style: solid">
                    <p><em style="font-weight: bold">EM Troubleshooting:</em> Note which atom has the highest forces in
                        the energy minimisation
                        output of GROMACS.<br>
                        E.g.:
                    <pre>Step= 1836, Dmax= 6.0e-05 nm, Epot= -5.42894e+05 Fmax= 1.94476e+02, atom= 19894</pre>
                    In VMD, go to the <code>Graphical Representations</code> window.
                    Create a new representation and for <code>Selected Atoms</code> choose <code>serial &lt;problem_atom_number&gt;</code>,
                    set
                    the <code>Drawing Method</code> to <code>VDW</code> and the <code>Coloring Method</code> to <code>ColorID</code>.
                    You will now be able to see which atom is causing the problem.</p>
                    <p>If you cannot clearly see the environment of the problem atom, you can replace the <code>Selected
                        Atoms</code>
                        in the default representation with <code>within 5 of serial &lt;problem_atom_number&gt;</code>
                    </p>
                    <p>
                        If a water molecule is causing the problem, you can follow the instructions from the <a
                            href="#Solvate_the_box"><code>solvate</code></a> step and remove it from the system.
                    </p>
                    <p>
                        If the problem is an ion, restart the procedure beginning from the <a
                            href="#Neutralise_the_excess_charge"> <code>genion</code></a> step.
                    </p>
                </div>
            </li>
        </ol>
    </div>
    <p>
        If the energy minimisation was successful, you can move on to the equilibration and production runs.
        These steps require more resources and will be carried out on Eddie.
    </p>
    <h2 class="enum" id="toc_9">Equilibrating the system</h2>
    <p>
        As in <a href="../session2/Session2.html#toc_3_2">Session 2</a>, in order to let your system reach
        a stable state, you need an equilibration run. For this system, you will only perform one equilibration run with
        temperature and pressure coupling (NPT ensemble).
    </p>
    <div class="bbox">
        <h3 id="Equilibrating_the_system_at_constant_temperature_and_pressure"></h3>
        <ol>
            <li>Equilibrate the system at constant temperature and pressure:</li>
            <li>Use the <code>eddie_run.sh</code> template to prepare the run script for the equilibration run (<code>run_eq.sh</code>)
                <p>
                    Refer to the <a href="../session2/Session2.html#Equilibrating_the_system_at_constant_temperature">Session
                    2</a> for instructions on how to prepare
                    the run script and adjust the parameters so that the output files all have the name <code>eq</code>.
                </p></li>
            <li> Copy the input files to your Eddie scratch directory:
                <pre>$ scp &dash;r ~/session3 &lt;UUN&gt;@eddie.ecdf.ed.ac.uk:/exports/eddie/scratch/&lt;UUN&gt;/</pre>
                <p class="note">Replace <code>&lt;UUN&gt;</code> with your university username.</p>
            </li>
            <li>
                Log into Eddie:
                <pre>$ ssh &dash;X &lt;UUN&gt;@eddie.ecdf.ed.ac.uk</pre>
            </li>
            <li>
                Navigate to the <code>session3</code> folder inside your directory
            </li>
            <li>Submit the job to the queue:
                <pre>$ qsub run_eq.sh</pre>
            </li>
            <li>Use <code>qstat</code> to check the status of your job.
                <pre>qstat -u &lt;UUN&gt;</pre>
            </li>
        </ol>
    </div>
    <h2 class="enum" id="toc_10">Running the production simulation</h2>
    <p>
        Now that you have a stable system, you can run the production simulation.
    </p>
    <div class="bbox">
        <h3 id="Running_the_production_simulation"></h3>
        <ol>
            <li>
                Run the production simulation:
            </li>
            <li>
                As before, use the <code>eddie_run.sh</code> template to prepare the run script for the production run (<code>run_prod.sh</code>)
                <p>
                    Adjust the parameters so that the output files all have the name <code>prod</code> and the input
                    files
                    are the output files from the equilibration run.
                </p>
            </li>
            <li>
                After the equilibration run has finished, submit the job to the queue:
                <pre>$ qsub run_prod.sh</pre>
            </li>
        </ol>
    </div>
</div>
<div class="box">
    <h2 class="enum" id="toc_11">Analysing the results</h2>
    <p>
        As in the previous session, while your simulation is running, you can use the files provided in the
        <code>example_data</code> folder to carry out the analysis steps.
    </p>
    <p>In this tutorial, you will:</p>
    <ul>
        <li>Calculate the root&dash;mean&dash;square deviation (<abbr>RMSD</abbr>) of the system to determine from which
            point on the system is equilibrated.
        </li>
        <li>Determine the radial distribution function (RDF) of the ions to analyse their hydration shell.</li>
        <li>Perform a linear density analysis of the ions on the axis perpendicular to the clay surface to characterise
            the interactions between ions and the clay surface.
        </li>
    </ul>
    <div class="bbox">
        <h3 id="Calculating_the_RMSD"></h3>
        <ol>
            <li>
                Calculate the <abbr>RMSD</abbr> of the system:
            </li>
            <li>
                Transfer the results from the production run to your local machine:
                <pre>$ scp &lt;UUN&gt;@eddie.ecdf.ed.ac.uk:/exports/eddie/scratch/&lt;UUN&gt;/session3/prod* ~/session3/</pre>
            </li>
            <li>Refer to the <a href="../session2/Session2.html#Calculating_the_RMSD">Session 2</a> for instructions on
                how to calculate the <abbr>RMSD</abbr> of the system.
            </li>
            <li>Visualise the result in xmgrace and determine the time point at which the system is equilibrated.
                <p class="note">
                    You will begin the subsequent analyses starting from this time point.
                </p></li>
            <li>Save the xmgrace plot as a <code>.png</code> file:
                <ol>
                    <li>In the xmgrace window open the <code>File</code> menu and select <code>Print setup</code></li>
                    <li>In the <code>Device setup</code> field <code>PNG</code></li>
                    <li>Set the file path in the <code>Output</code> field and include the <code>.png</code>
                        suffix.
                    </li>
                    <li>Click <code>Apply</code> and <code>Accept</code></li>
                    <li>In the <code>File</code> menu, click <code>Print</code>.</li>
                </ol>
            </li>
        </ol>
    </div>
    <h3 id="toc_11_1">Calculating the radial distribution function</h3>
    <p>
        The radial distribution function (<abbr>RDF</abbr>) is a measure of the probability of finding a particle at a
        certain distance from another particle. We are going to use it to analyse the hydration shell of Na<sup>+</sup>
        ions.
    </p>
    <div class="bbox">
        <h3 id="Calculating_the_RDF"></h3>
        <ol>
            <li>
                Calculate the radial distribution function of the ions:
            </li>
            <li>
                Use the the <a href="https://manual.gromacs.org/documentation/2019/onlinehelp/gmx-make_ndx.html"
                               rel="noopener" target="_blank"><code>make_ndx</code></a> tool to create an index file for
                Na<sup>+</sup> ions and water OW atoms.
                <p>GROMACS does not have Na<sup>+</sup> and water <code>OW</code> atoms in its default selections.
                    Therefore, we have to first create a new index <code>.ndx</code> file that also contains these atom
                    groups:</p>
                <blockquote>
                    <pre>$ gmx make_ndx &dash;f prod.gro &dash;o Na_OW.ndx</pre>
                    <p>Select NA and OW atoms by adding two new groups to the index file:<br>
                        Type each line and press <code>Enter</code>.</p>
                    <pre>&gt; a NA</pre>
                    <pre>&gt; a OW</pre>
                    <p>Exit and save the index file by typing <code>q</code> and pressing <code>Enter</code>.
                    </p>
                </blockquote>
            </li>
            <li>
                Use the <a href="https://manual.gromacs.org/documentation/2019/onlinehelp/gmx-rdf.html" rel="noopener"
                           target="_blank"><code>gmx rdf</code></a> tool to calculate the <abbr>RDF</abbr>:
                <blockquote>
                <pre>
$ gmx rdf &dash;f prod.xtc &dash;s prod.tpr &dash;n Na_OW.ndx &dash;o rdf_Na_OW.xvg &dash;seltype atom &dash;selrpos atom &dash;b &lt;analysis_start_time&gt; &dash;tu &lt;time_unit&gt; &dash;norm number_density &dash;rmax 1</pre>
                    <p><code>&dash;f</code> specifies the trajectory file.</p>
                    <p><code>&dash;s</code> specifies the input topology <code>.tpr</code> file.</p>
                    <p><code>&dash;o</code> specifies the ouput file.</p>
                    <p><code>&dash;seltype</code> specifies the selection type.</p>
                    <p><code>&dash;selrpos</code> specifies the positions used in the analysis.</p>
                    <p><code>&dash;b</code> specifies the start time for the analysis.</p>
                    <p><code>&dash;tu</code> specifies the time unit.</p>
                    <p><code>&dash;norm</code> specifies if the density should be normalised to 1.
                        Here we select to keep the number density which will represent the number of atoms in the
                        hydration shell.</p>
                    <p><code>&dash;rmax</code> specifies the maximum distance between two atoms in the analysis.</p>
                    <p>Then, first select <code>OW</code> by typing the group number and hitting <code>Enter</code> and
                        then
                        add <code>Na</code> to the selection. Hit <code>Enter</code> again and exit with
                        <code>Ctrl+D</code></p>
                </blockquote>
            </li>
            <li>
                Use xmgrace to visualise the result.
            </li>
        </ol>
    </div>
    <div class="box">
        <h2 class="enum" id="toc_12">Visualising the results</h2>
        <p>
            You can use the same procedure as in the setup procedure to visualise the trajectory.
        </p>
        <div class="bbox">
            <h3 id="Visualise_trajectory_in_VMD"></h3>
            <ol>
                <li>Visualise the trajectory in <abbr>VMD</abbr></li>
                <li>Open <abbr>VMD</abbr> and load the <code>prod.gro</code> file.</li>
                <li>Load the trajectory file into the molecule.
                    <blockquote>
                        <p>
                            Right&dash;click on the molecule and select <code>Load Data into Molecule</code>.
                            Then, select the <code>prod.xtc</code> trajectory file.
                        </p>
                        <p class="note">The loading of all the frames might take some time. You can speed up the
                            proceed if
                            you hide the molecule during this process. To do this, click on the <code>D</code> next to
                            the molecule
                            entry in the main menu. It will turn red and the molecule will be hidden. Once the
                            trajectory is
                            loaded, you can click on the <code>D</code> again to show the molecule.
                            Use the <code>Play</code> button to play the trajectory. You can adjust the playback with
                            the
                            controls at the bottom of the main window.
                        </p>
                    </blockquote>
                </li>
            </ol>
        </div>
    </div>
</div>
<script defer src="../scripts/generate_header.js"></script>
<script defer src="../scripts/generate_overview.js"></script>
<script defer src="../scripts/scroll_up.js"></script>
<script defer src="../scripts/feedback.js"></script>
<script defer src="../scripts/adjust_for_dyslexia.js"></script>
<script>window.onload = function () {
    addFeedback('https://forms.office.com/e/VukKtnCbxq?origin=lprLink', 'img/FB3.png')
    generateOverview();
    generateHeader();
    scrollUp();
    adjustForDyslexia();
}</script>
</body>
</html>
