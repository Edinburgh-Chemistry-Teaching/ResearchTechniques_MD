<!DOCTYPE html>
<html lang="en-UK">
<!--xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">-->

<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, user-scalable=yes" name="viewport"/>
    <meta content="Session 3: Layered material simulations" name="description"/>
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:ital,wght@0,400;0,600;1,400&display=swap"
          rel="stylesheet">
    <link href="../style.css" rel="stylesheet"/>
    <title>Session 3</title>
</head>


<body>

<div class="box">
    <h1 id="title">Layered Material Setup</h1>
<!--    <p><strong>Contact:</strong><br/>-->
<!--        Dr Valentina Erastova (<a href="mailto:valentina.erastova@ed.ac.uk">valentina.erastova@ed.ac.uk</a>)<br/>-->
<!--        Office B21 (Office hours Wedn 10.00&dash;12.00 in weeks 3, 4 and 5)-->
<!--    </p>-->
<!--    <p><strong>Demonstrators:</strong></p>-->
<!--    <ul>-->
<!--        <li>Hannah Pollak</li>-->
<!--        <li>Audrey Noumbissi Ngambia</li>-->
<!--        <li>Sarah Stewart</li>-->
<!--    </ul>-->
</div>
<div class="box">
    <h2 id="outcomes">Learning Outcomes</h2>
    <p>By the end of this session you should be able to:</p>
    <ul>
        <li>Prepare a simple input file for a simulation</li>
        <li>Run a simple simulation of a layered material</li>
        <li>Visualise the results of the simulation</li>
    </ul>
</div>
<div class="box">
    <h2 id="overview">Contents</h2>

    <!--    <ol class="toc-list">-->
    <!--        <li> Assembling the system-->
    <!--            <ol>-->
    <!--                <li> Clay</li>-->
    <!--                <li> Organics</li>-->
    <!--                <li> Brine</li>-->
    <!--            </ol>-->
    <!--        </li>-->
    <!--        <li> Running the simulation-->
    <!--            <ol>-->
    <!--                <li> Energy minimisation</li>-->
    <!--                <li> Equilibration</li>-->
    <!--                <li> Production</li>-->
    <!--            </ol>-->
    <!--        </li>-->
    <!--    </ol>-->
</div>
<div class="box">
    <h2 class="enum" id="toc_1">Introduction</h2>
        <p>
        <em>This tutorial was created by Hannah Pollak and Valentina Erastova and is based upon the <a
                href="https://www.erastova.xyz/teaching/practical-simulations-for-molecules-and-materials/material-simulations/material-simulations-set-up/">Layered material simulations set up</a> tutorial by Valentina Erastova.</em>
    </p>
    <p>
        Clays are a diverse group of minerals that are found in soils and sediments throughout the world.
        Their basic structural unit is a layer composed of one or two sheets of silica tetrahedra,
        [Si<sup>4+</sup>O<sub>5</sub>]
        and one sheet of divalent or trivalent metal octahedra, [M<sup>2+</sup><sub>3</sub>(OH)<sub>2</sub>O<sub>4</sub>]
        (M<sup>2+</sup>
        = Mg<sup>2+</sup>, Fe<sup>2+</sup>, ...),
        or [M<sup>3+</sup><sub>2</sub>(OH)<sub>2</sub>O<sub>4</sub>] (M<sup>3+</sup> = Al<sup>3+</sup>, Fe<sup>3+</sup>).
        These layers are stacked on top of each other to form a 3D structure.
        So&dash;called <em>isomorphous substitution</em> of tetrahedral Si<sup>4+</sup> by a M<sup>3+</sup> ion or
        octahedral
        M<sup>3+</sup>/M<sup>2+</sup> by M<sup>2+</sup>/M<sup>1+</sup> ions
        result in a net negative charge on the clay mineral. This negative <em>layer charge</em> is balanced by the
        presence
        of cations (Na<sup>+</sup>, K<sup>+</sup>, Ca<sup>2+</sup>, Mg<sup>2+</sup>, ...) in the interlayer space.
        <!--        <div class="fit-picture">-->
    </p>
    <div class="flex-figure">
        <div class="flex-figure-item">
            <figure>
                <img alt="" class="fit-picture" decoding="auto"
                     src="img/clay_sheet_structure.png" width="40%"/>
                <img alt="" class="fit-picture" decoding="auto" src="img/clay_with_IL.png"
                     width="50%"/>
                <figcaption>
                    Side view illustrations of clay sheet structure and composition (left) and two stacked clay with
                    interlayer space (right).
                </figcaption>
            </figure>
        </div>
    </div>
</div>
<div class="box" style="width: 50%; border: solid 1px dimgray; background-color: #b3d4fc; color: dimgray">
    <p>
        Their unique structure dictates their physical and chemical behaviour, as well as their interactions with other
        molecules and ions.
        Clays for all the 3 different parts.</p>
    <ul>
        <li>Medicinal and Biological chemistry<br>
            Clay minerals have a wide range of applications in the pharmaceutical industry. They are employed as
            excipients and drug delivery agents, as well as, thickeners and absorbents.
        </li>
        <li>Materials chemistry<br>
            Clay minerals are used in the production of ceramics, glass, paper, paints, rubber, polymers,
            insecticides and many other industrial and domestic products.
        </li>
        <li>Analytical chemistry<br>
            Clay minerals are used in the analysis of a wide range of materials, including soils, sediments, rocks,
            water and air.
        </li>
    </ul>
</div>
<div class="box">
    <p>
        Today's system will be a montmorillonite <abbr>MMT</abbr> in contact with water, ions and organic molecules.
        We will start by building the clay sheets from unit cell (<abbr>UC</abbr>) building blocks.
        The composition of this unit cell is the following:
        [Si<sup>4+</sup><sub>8</sub>O<sub>5</sub>][Al<sup>3+</sup><sub>3</sub>Mg<sup>2+</sup>(OH)<sub>2</sub>O<sub>4</sub>]<sup>
        &dash;1</sup>. The &dash;1 charge originates from one of the octahedral Al<sup>3+</sup> atoms being substituted
        by a
        Mg<sup>2+</sup> atom.
        In theis session tutorial, the atoms are colour&dash;coded according to the following scheme:</p>

    <table>
        <caption>Atom type colours</caption>
        <colgroup>
            <col span="5">
        </colgroup>
        <thead>
        <tr>
            <th>Element</th>
            <th>Colour</th>
            <th style="color: transparent">empty</th>
            <th>Element</th>
            <th>Colour</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>Si</td>
            <td style="background-color: yellow; font-weight: bolder">yellow</td>
            <td style="color: transparent">empty</td>
            <td>Al</td>
            <td style="background-color: darkcyan; color: white; font-weight: bolder">cyan</td>
        </tr>
        <tr>
            <td>O</td>
            <td style="background-color: red; color: white; font-weight: bolder">red</td>
            <td style="color: transparent">empty</td>
            <td>Mg</td>
            <td style="background-color: darkviolet; color: white; font-weight: bolder">purple</tD>
        </tr>
        <tr>
            <td>H</td>
            <td style="background-color: white; color: black; font-weight: bolder">white</td>
            <td style="color: transparent">empty</td>
            <td>C</td>
            <td style="background-color: #333333; color: white; font-weight: bolder">gray</tD>
        </tr>
        </tbody>
    </table>
    <!--        <span style="align-content: center; text-align: justify; align-items: center">-->
    <div class="flex-container">
        <div class="flex-item">
            <figure>
                <img alt="" class="fit-picture" decoding="auto" src="img/uc_top.png"
                     width="35%"/>
                <img alt="" class="fit-picture" decoding="auto" src="img/uc_side.png"
                     width="55%"/>
                <figcaption>
                    Montmorillonite unit cell top view (left) and side view (right).
                </figcaption>
            </figure>
        </div>
    </div>

    <!--        <figure>-->
    <!--            <img width="250px" decoding="auto" src="img/uc_top.png" class="fit-picture" alt="" />-->
    <!--            <img width="350px" decoding="auto" src="img/uc_side.png" class="fit-picture" alt="" />-->
    <!--        <figcaption>-->
    <!--            Montmorillonite unit cell top view (left) and side view (right).-->
    <!--        </figcaption>-->
    <!--        </figure>-->


    <!--        </span>-->
</div>
<div class="box">
    <h2 class="enum" id="toc_2">Building the clay sheets</h2>
    <p>
        Before you start on this practical, let's create a working directory for this session.
    </p>
    <div class="bbox">
        <h3 id="Creating_the_working_directory"></h3>
        <ul>
            <li>Create the working directory for this session</li>
            <li>Copy the <code>session3</code> folder from practicals to your home directory:
                <p>Open a terminal and type:</p>
                <pre>cp -r /home/practicals/session3 .</pre>
            </li>
            <li>Change into the <code>session3</code> directory:
                <pre>cd session3</pre>
            </li>
        </ul>
    </div>
    <!--    <p>-->
    <!--        There are two steps in building a system for an <abbr title="Molecular Dynamics">MD</abbr> simulation:</p>-->
    <!--    <ol>-->
    <!--        <li> Creating the structure</li>-->
    <!--        <li> Assigning the topology</li>-->
    <!--    </ol>-->
    <p>
        The clay model will consist of a single montmorillonite clay sheet. The first step is to create a sheet by
        multiplying a single <abbr>MMT</abbr> <abbr>UC</abbr>.
        This can be done using GROMACS <code>genconf</code>.
    </p>

    <div class="bbox">
        <h3 id="Create_a_clay_sheet"></h3>
        <ul>
            <li>Use <code>genconf</code> to create a single clay sheet from 24 <abbr>MMT</abbr> <abbr>UCs</abbr>
                (<code>MMT.gro</code>):
            </li>
            <li>Usage of <code>genconf</code>: <br>
                <blockquote>
                    <pre>gmx genconf &dash;f MMT.gro &dash;nbox &lt;x_ucs&gt; &lt;y_ucs&gt; &lt;z_ucs&gt; &dash;o MMT_slab.gro</pre>
                    <code>&dash;f</code> specifies the structure file of the system to insert into.<br>
                    <code>&dash;nbox</code> defines the number of unit cells to put in each of <em>x y z</em>
                    directions.<br>
                    <code>&dash;o</code> specifies the output file name.<br>
                    If you only want one layer of clay, use 1 in the z&dash;direction.
                </blockquote>
            </li>
            <li>How many (<abbr>UCs</abbr>) do you need to multiply in x&dash; and y&dash;direction?
                <blockquote>
                    Check the size of unit cell and remember the size of the box has to be at least 2.5 x the size
                    of your cutoff.<br>
                    So, for a cutoff at 1.2 nm you have to aim at ~3 nm on each side.
                </blockquote>
                <div class="flex-container">
                    <div class="flex-item">
                        <figure>
                            <img alt="" class="fit-picture" decoding="auto"
                                 src="img/sheet_top.png"
                                 width="45%"/>
                            <img alt="" class="fit-picture" decoding="auto"
                                 src="img/sheet_side.png"
                                 width="50%"/>
                            <figcaption>
                                Montmorillonite sheet model top view (left) and side&dash;view (right).
                            </figcaption>
                        </figure>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    <p>
        The box of this sheet model currently has no space for inserting organic molecules, solvent or ions.
        Therefore, before moving on, you need to change the box height.
    </p>
    <div class="bbox">
        <h3 id="Increase_the_box_height"></h3>
        <ul>
            <li>Edit the gro file to increase the box height</li>
            <li>Increase the box <em>z</em> length by editing the <code>MMT_slab.gro</code> file.
                <blockquote>
                    Where in the <code>.gro</code> file is the box size specified? Adjust the sheet spacing to 25
                    &#8491;
                </blockquote>
                <div class="flex-figure">
                    <div class="flex-figure-item">
                        <figure>
                            <img alt="" class="fit-picture" decoding="auto"
                                 src="img/sheet_side_ext.png"
                                 width="55%"/>
                        </figure>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    <h2 class="enum" id="toc_3">Adding decanoic acid molecules</h2>
    Now that you have a clay sheet, you can use <code>insert&dash;molecules</code> insert decanoic acid molecules into
    the vacuum space.
    <div class="bbox">
        <h3 id="Insert_decanoic_acid_molecules"></h3>
        <ul>
            <li>Use <code>insert&dash;molecules</code> to insert 10 decanoic acid molecules into the vacuum space above
                the clay sheet (<code>MMT_slab.gro</code>):
            </li>
            <li>Usage of <code>insert&dash;molecules</code>: <br>
                <blockquote>
                    <pre>gmx insert&dash;molecules &dash;f MMT_slab.gro &dash;ci dec_acid.gro &dash;nmol &lt;number&gt; &dash;o MMT_dec.gro</pre>
                    <code>&dash;f</code> specifies the coordinate file of the system to insert into.<br>
                    <code>&dash;ci</code> specifies the coordinate file of the molecule to insert.<br>
                    <code>&dash;nmol</code> defines the number of molecules to insert.<br>
                    <code>&dash;o</code> specifies the output coordinate file name.<br>
                    <p>GROMACS will try to fit the requested number of molecules in the available space. It will
                        notify you about whether it was successful or not.
                    </p>
                </blockquote>
                <div class="flex-figure">
                    <div class="flex-figure-item">
                        <figure>
                            <img alt="" class="fit-picture" decoding="auto"
                                 src="img/sheet_side_ext_dec.png"
                                 width="55%"/>
                        </figure>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    <h2 class="enum" id="toc_4">Preparing the topology file</h2>
    <p>
        Before proceeding to the next step in which you will solvate the box, you need to generate a topology
        (<code>.top</code>) file
        that include all molecules present in the system. The following sections explain the structure of GROMACS
        topology files in some more detail than in <a href="../Session2/Session2.html">Session2</a>.
    </p>
    <p>
        In the first section, the force field parameters are defined. These always include combination rules and
        non&dash;bonded interaction parameters (atom types, atomic masses, atomic charges, Lennard&dash;Jones
        parameters).
        They can optionally include
        bonded interaction definitions (bond, angle and dihedral types with bond, angle and dihedral interaction
        force constants and equilibrium values in this order). A detailed explanation can be found in the GROMACS
        documentation pages: <a
            href="https://manual.gromacs.org/current/reference-manual/topologies/topology-file-formats.html#topfile"
            rel="noopener"
            target="_blank">topology files</a>,
        <a href="https://manual.gromacs.org/current/reference-manual/topologies/topologies.html" rel="noopener"
           target="_blank">topologies</a> and
        <a
                href="https://manual.gromacs.org/current/reference-manual/functions/functions.html#ff"
                rel="noopener"
                target="_blank">force fields</a>.<br>
    </p>
    <p>
        Even if they only consist of one atom, all atoms of the system are part of molecules. These <code>[
        moleculetype ]</code> are defined
        In the second section, all molecule type definitions, such as the <abbr>MMT</abbr> <abbr>UC</abbr>,
        decanoic acid molecule, water molecule and ions need to be included in the topology file.
    </p>
    <p> Elements from the first two sections are usually defined in separate files that are included in the topology
        file.
        The syntax for including files is <code>#include &quot;&lt;filename&gt;&quot;</code>.</p>
    <p>
        The third section contains the system name and the number of molecules of each type in the system. The
        system section starts with the keyword <code>[ system ]</code> and is followed by a name chosen for the
        system (The choice of the name does not really matter).<br>
        The number of molecules of each type is specified in the <code>[ molecules ]</code> section.</p>
    <p>
        <em>Important:</em> The order of the molecules in the <code>[ molecules ]</code> section must match the
        order of the molecules in the <code>.gro</code> file.

    </p>
    <div class="bbox">
        <h3 id="Generate_the_topology_file"></h3>
        <ol>
            <li>Generate a topology file for the system (<code>MMT_slab.top</code>):</li>
            <li>Open the topology file stub <code>MMT_slab.top</code> in a text editor to fill in missing
                sections.<br>
            </li>
            <!--                <li>Include the definition files for combination rules (<code>'forcefield.itp</code>) from ClayFF.-->
            <!--                    <blockquote>-->
            <!--                        <pre>#include "FF/charmm36.ff/forcefield.itp"</pre>-->
            <!--                        All force field folders (<code>&lt;ForceFieldName.ff&gt;</code>) are located within the-->
            <!--                        <code>FF</code> directory. The force field for clay and water is ClayFF, for organics and ions-->
            <!--                        it is CHARMM36 and for ions it is Ions.-->
            <!--                        Inside each of the folders, you can find the <code>.itp</code> files that contain the various-->
            <!--                        force field parameters.-->
            <!--                        The combination rules are only be specified once and will be the same for all atoms even if-->
            <!--                        their parameters belong to different force fields.-->
            <!--                    </blockquote>-->
            <li>Add nonbonded parameter files (<code>ffnonbonded.itp</code>) for clay, organics and ions.
                <blockquote>
                    All force field folders (<code>&lt;ForceFieldName.ff&gt;</code>) are located within the
                    <code>FF</code> directory. The force field for clay and water is ClayFF, for organics and ions
                    it is CHARMM36 and for ions it is Ions.
                    Inside each of the folders, you can find the <code>.itp</code> files that contain the various
                    force field parameters. <br>
                    Clay and water share the same atom types. Therefore, no separate
                    <code>ffnonbonded.itp</code> file needs to be added for water.<br>
                    <p class="remember"> Everything that comes after a <code>;</code> will be trated as a comment and
                        is
                        not read by GROMACS.</p>
                </blockquote>
            </li>
            <li>Add bonded parameters for organics (<code>ffbonded.itp</code>).</li>
            <li>Include molecule definitions for ions (<code>ions.itp</code>), water (<code>spc.itp</code>),
                <abbr>MMT</abbr>
                (<code>MMT.itp</code>) and decanoic acid (<code>dec_acid.itp</code>).
            </li>
            <li>Complete the molecules section.
                <blockquote>Add entries for all molecules in your <code>.gro</code> file.<br>
                    E.g. for two <abbr>MMT</abbr> <abbr>UCs</abbr> and one decanoic acid, the entry would be:
                    <pre>
[ molecules ]
; Compound  # mols
MMT           2
DEC           1
                </pre>
                </blockquote>

            </li>
        </ol>
    </div>
    <h2 class="enum" id="toc_5">Solvating the system</h2>
    <p>
        Now that you have a topology file, you can use GROMACS <code>solvate</code> the box.
    </p>
    <div class="bbox">
        <h3 id="Solvate_the_box"></h3>
        <ul>
            <li value="">Use <code>solvate</code> to solvate the box with water (<code>MMT_dec.gro</code>):</li>
            <li>Usage of <code>solvate</code>: <br>
                <blockquote>
                    <pre>gmx solvate &dash;cp MMT_dec.gro &dash;cs spc216.gro &dash;o MMT_dec_solv.gro &dash;p MMT_slab.top &dash;po MMT_dec_solv.top</pre>
                    <code>&dash;cp</code> specifies the input coordinate file of the system to solvate.<br>
                    <code>&dash;cs</code> specifies the water model coordinate file.<br>
                    <code>&dash;o</code> specifies the output coordinate file.<br>
                    <code>&dash;p</code> specifies the input topology file.<br>
                    <code>&dash;po</code> specifies the output topology file.<br>
                    <p>GROMACS will try to fill the available space with solvent and update the number of water
                        (<code>SOL</code>)
                        molecules in the output topology file.
                    </p>
                </blockquote>
                <p>After this step, make sure to visualise the system in VMD to check that no water molecules
                    were inserted into or very close to the clay sheets. If this was the case, you can either
                    repeat the solvation step (make sure to delete the <code>SOL</code> line from the topology
                    first) or remove the water molecules manually. In order to manually remove water molecules,
                    look at the system in VMD and press &quot;1&quot; on your keyboard to select the water molecules
                    that
                    are too close to the clay. The label od the selected water molecule will then show you
                    which residue you will need to remove from the <code>.gro</code> file. E.g. if the label
                    shows <code>SOL60:HW1</code> (see figure below), you will need to remove the three
                    <code>SOL60</code> line
                    from the <code>MMT_dec_solv.gro</code> file and change the number of atoms in the header
                    to match the new number of atoms in the file. Make sure to also update the number of water
                    molecules in the <code>MMT_slab.top</code> file.</p>
                <div class="flex-figure">
                    <div class="flex-figure-item">
                        <figure>
                            <img alt="" class="fit-picture"
                                 decoding="auto"
                                 src="img/sheet_side_water_mol.png"
                                 width="55%"/>
                            <figcaption>
                                Water molecule <code>SOL60</code> inside the clay sheet.
                            </figcaption>
                        </figure>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    <h2 class="enum" id="toc_6">Adding ions to neutralise the system</h2>
    <p>
        Now that you have a solvated system, but because of the substitutions in the clay sheet and the deprotonated
        decanoic acid molecules, the system has a net negative charge.
        It is not possible to run a simulation with a charged system. Therefore, you need to neutralise the system
        with cations.
        You can use <code>genion</code> to add ions and neutralise the system.
    </p>
    <div class="bbox">
        <h3 id="Neutralise_the_excess_charge"></h3>
        <ol>
            <li>Neutralise the system with Na<sup>+</sup> ions:</li>
            <li>Generate a run <abbr>TPR</abbr> file for the system (<code>MMT_dec_solv.tpr</code>):
                <p>
                    Since <code>genion</code> is a type of <abbr>MD</abbr> run, you need to first use
                    <code>grompp</code> to
                    generate a <code>TPR</code> file. The contents of the <code>MDP</code> input file is not important
                    for
                    this step, but it has to be given.</p>
                <p>Usage of <code>grompp</code>:</p>
                <blockquote>
                    <pre>gmx grompp &dash;f genion.mdp &dash;c MMT_dec_solv.gro &dash;p MMT_dec_solv.top &dash;o MMT_dec_solv.tpr &dash;pp MMT_dec_solv_ions.top</pre>
                    <code>&dash;f</code> specifies the input run parameter file.<br>
                    <code>&dash;c</code> specifies the coordinate file of the system to solvate.<br>
                    <code>&dash;p</code> specifies the topology file.<br>
                    <code>&dash;o</code> specifies the compiled output <code>.tpr</code> file.<br>
                    <code>&dash;pp</code> specifies the output topology file.<br>
                    <p class="note"> Because <code>genion</code> is an <abbr>MD</abbr> run, the <code>&dash;pp</code>
                        option
                        to generate a new topology file with ions is used here rather than with the <code>genion</code>
                        command.</p>
                </blockquote>
                <p>
                    <code>grompp</code> will generate a note similar to this one:
                </p>
                <pre>
NOTE 3 [file MMT_slab_dec_solv.top, line 40]:
In moleculetype 'MMT' 32 atoms are not bound by a potential or constraint
to any other atom in the same moleculetype. Although technically this
might not cause issues in a simulation, this often means that the user
forgot to add a bond/potential/constraint or put multiple molecules in
the same moleculetype definition by mistake. Run with <code>&dash;v</code> to get
information for each atom.
</pre>
                <p>
                    This note is not an error, but a warning that the atoms in the clay sheet are not bonded to each
                    other. Because ClayFF is a non&dash;bonded force field, this is not an error, and you can ignore
                    this
                    message.
                </p>
            </li>
            <li>Use <code>genion</code> to neutralise the system with Na<sup>+</sup> ions:
                <p>Usage of <code>genion</code>: </p>
                <blockquote>
                    <pre>gmx genion &dash;s MMT_dec_solv.tpr &dash;o MMT_dec_solv_ion.gro &dash;p MMT_dec_solv.top &dash;pname Na &dash;nname Cl &dash;neutral</pre>
                    <code>&dash;s</code> specifies the input coordinate file of the system to solvate.<br>
                    <code>&dash;o</code> specifies the output coordinate file<br>
                    <code>&dash;p</code> specifies the input topology file<br>
                    <code>&dash;pname</code> specifies the name of the positive ion<br>
                    <code>&dash;nname</code> specifies the name of the negative ion<br>
                    <code>&dash;neutral</code> &ndash; neutralise the system<br>
                    <p>GROMACS will try to fill the available space with solvent and update the number of water
                        (<code>SOL</code>)
                        molecules in the output topology file.</p>
                    <p>
                        You will be asked which molecules should be replaced with ions. Select the code for the
                        water <code>SOL</code> molecules.
                    </p>
                </blockquote>
            </li>
        </ol>
    </div>
    <h2 class="enum" id="toc_7">Preparing the <abbr>MD</abbr> simulation parameter files</h2>
    <p>
        Now your system is ready for simulation.
    </p>
    <p>
        You can follow the same procedure as in the previous session to run the simulation.
    </p>
    <div class="bbox">
        <h3 id="Prepare_mdp_files"></h3>
        <ol>
            <li>Use the <code>MDP</code> template files inside the <code>MDP</code> directory and complete
                the
                missing keyword sections:
            </li>
            <li>Energy minimisation: <code>em.mdp</code>
                <br>Set the maximum number of steps to 5000 and the force tolerance to 1000 kJ mol<sup>&dash;1</sup>
                nm<sup>&dash;1</sup>.
            </li>
            <li>Equilibration: <code>eq.mdp</code><br>
                Set the run time to 100 ps and the time step to 1 fs.
            </li>
            <li>Production: <code>prod.mdp</code><br>
                Set the run time to 10 ns and the time step to 2 fs.
            </li>
        </ol>
        <p class="note"> Make sure you provide the parameters for the <code>.mdp</code> file in the correct
            units.
            The units used by <abbr>GROMACS</abbr> can be found in the Reference Manual: <a
                    href="https://manual.gromacs.org/documentation/2019/reference-manual/definitions.html"
                    rel="noopener" target="_blank">manual.gromacs.org/documentation/2019/reference&dash;manual/definitions.html</a>.
        </p>
    </div>
    <h2 class="enum" id="toc_8">Minimising the energy</h2>
    <p>
        Let's start with the energy minimisation. This step should not take too long and can be carried out on the
        virtual machine. </p>
    <div class="bbox">
        <h3 id="Run_energy_minimisation"></h3>
        <ol>
            <li>Run the energy minimisation:</li>
            <li>Compile the run topology file for the energy minimisation
                (<code>MMT_dec_solv_ion_em.tpr</code>):
                <blockquote>
                    <pre>gmx grompp &dash;f MDP/em.mdp &dash;c MMT_dec_solv_ion.gro &dash;p MMT_dec_solv_ion.top &dash;o MMT_dec_solv_ion_em.tpr</pre>
                    <code>&dash;f</code> specifies the input run parameter <code>.mdp</code> file.<br>
                    <code>&dash;c</code> specifies the input coordinate file.<br>
                    <code>&dash;p</code> specifies the topology file.<br>
                    <code>&dash;o</code> specifies the compiled output <code>.tpr</code> file.<br>
                </blockquote>
            </li>
            <li>
                Run the energy minimisation
                <blockquote>
                    <pre>gmx mdrun &dash;s MMT_dec_solv_ion_em.tpr &dash;deffnm MMT_dec_solv_ion_em &dash;v</pre>
                    <code>&dash;s</code> specifies the compiled input <code>.tpr</code> file.<br>
                    <code>&dash;deffnm</code> specifies the output file naming pattern.<br>
                    <code>&dash;v</code> specifies that the output should be verbose.
                </blockquote>
                <p>
                <p>Before moving on to the equilibration, you should check the energy minimisation log file
                    (<code>MMT_dec_solv_ion_em.log</code>) to make sure that the energy minimisation was successful.
                    If the energy minimisation was successful, the log file should end with a message similar to this
                    one:</p>
                <pre>
Steepest Descents converged to Fmax < 500 in 1209 steps
Potential Energy  = -4.5789000e+06
Maximum force     =  4.9707333e+02 on atom 2904
Norm of force     =  2.2770223e+01
</pre>
                <p class="note">
                    If instead you find something along these lines:
                </p>
                <pre>
Steepest Descents converged to machine precision in 192 steps,
but did not reach the requested Fmax < 500.
Potential Energy  = -6.8659256e+05
Maximum force     =  6.5820524e+07 on atom 715
Norm of force     =  1.6491472e+06
</pre>
                <p>This means that the energy minimisation did not converge. This means that GROMACS was not able to
                    reach a minimum
                    where the maximum force was below the specified threshold. In this case, you will probably need to
                    repeat parts of the assembly procedure or remove water molecules that are too close to the clay,
                    organics or other waters. Before repeating, move on to the <a
                            href="../Session2/Session2.html#visualise_1">visualisation
                        task</a> but follow the instructions
                    marked with <em>EM Troubleshoot</em>.</p>
                </p>
            </li>
        </ol>
    </div>
    <h2 class="enum" id="toc_9">Equilibrating the system</h2>
    <h2 class="enum" id="toc_10">Running the production simulation</h2>
    <h2 class="enum" id="toc_11">Visualising the trajectory</h2>
    <p>open the final coordinate
        file <code>MMT_dec_solv_ion.gro</code> in VMD and
    <p><em style="font-weight: bolder; font-size-adjust: 1; padding: 0; margin: 0">DONE!</em><br></p>
    <h2 class="enum" id="toc_13">Visualising the results</h2>
    <p>
        You can use the same procedure as in the setup procedure to visualise the trajectory.
    </p>
    <div class="bbox">
        <h3 id="Visualise_trajectory_in_VMD"></h3>
        <ol>
            <li>Open <abbr>VMD</abbr> and load the <code>MMT_dec_solv_ion.gro</code> file.</li>
            <li>Load the trajectory file into the molecule.
                <blockquote>
                    <p>
                        Right&dash;click on the molecule and select <code>Load Data into Molecule</code>.
                        Then, select the <code>MMT_dec_solv_ion.trr</code> trajectory file.
                    </p>
                    <p class="note">The loading of all the frames might take some time. You can speed up the
                        proceed if
                        you hide the molecule during this process. To do this, click on the <code>D</code> next to
                        the molecule
                        entry in the main menu. It will turn red and the molecule will be hidden. Once the
                        trajectory is
                        loaded, you can click on the <code>D</code> again to show the molecule.
                        Use the <code>Play</code> button to play the trajectory. You can adjust the playback with
                        the
                        controls at the bottom of the main window.
                    </p>
                </blockquote>
            </li>
        </ol>
    </div>
        <script src="../VM_sessions/scripts/generate_header.js"></script>
        <script src="../VM_sessions/scripts/generate_overview.js"></script>
        <script src="../VM_sessions/scripts/scroll_up.js"></script>
        <script>window.onload = function () {
            addFeedback('https://forms.office.com/e/VukKtnCbxq?origin=lprLink', 'img/FB3.png')
            generateOverview();
            generateHeader();
            scrollUp();
        }</script>
</body>
</html>
